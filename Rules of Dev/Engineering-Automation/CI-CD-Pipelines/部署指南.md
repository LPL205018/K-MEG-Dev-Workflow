# CI/CD Pipeline éƒ¨ç½²èˆ‡ç®¡ç†æŒ‡å—

## ğŸ“ ç›®éŒ„çµæ§‹

æ­¤è³‡æ–™å¤¾åŒ…å«æ‰€æœ‰ GitHub Actions å·¥ä½œæµé…ç½®ï¼š

```
CI-CD-Pipelines/
â”œâ”€ main-pipeline.yml          # æ ¸å¿ƒ CI æµç¨‹ï¼ˆæ‰€æœ‰æª¢æŸ¥ï¼‰
â”œâ”€ pr-checks.yml              # PR ç›¸é—œçš„è‡ªå‹•æª¢æŸ¥
â”œâ”€ release-pipeline.yml       # ç™¼ä½ˆèˆ‡éƒ¨ç½²æµç¨‹ï¼ˆM3+ï¼‰
â””â”€ éƒ¨ç½²æŒ‡å—.md               # æœ¬æ–‡æª”
```

---

## ğŸš€ å·¥ä½œæµç¨‹èªªæ˜

### 1. main-pipeline.ymlï¼ˆæ ¸å¿ƒæª¢æŸ¥ï¼‰

**è§¸ç™¼æ¢ä»¶ï¼š**
- Push åˆ° `main` æˆ– `develop` åˆ†æ”¯
- å‰µå»º Pull Request åˆ° `main` æˆ– `develop`

**åŸ·è¡Œå…§å®¹ï¼š**

```
Python å¾Œç«¯
â”œâ”€ Black æ ¼å¼æª¢æŸ¥
â”œâ”€ Ruff Lint æª¢æŸ¥
â”œâ”€ Pyright é¡å‹æª¢æŸ¥
â”œâ”€ Pytest å–®å…ƒæ¸¬è©¦ (90% è¦†è“‹)
â””â”€ Bandit å®‰å…¨æƒæ

TypeScript å‰ç«¯
â”œâ”€ Prettier æ ¼å¼æª¢æŸ¥
â”œâ”€ ESLint Lint æª¢æŸ¥
â”œâ”€ TSC é¡å‹æª¢æŸ¥
â”œâ”€ Vitest å–®å…ƒæ¸¬è©¦ (80% è¦†è“‹)
â”œâ”€ npm audit å®‰å…¨æƒæ
â””â”€ Vite Build æª¢æŸ¥

C# å¾Œç«¯
â”œâ”€ Roslyn Formatter æª¢æŸ¥
â”œâ”€ StyleCop Lint æª¢æŸ¥
â”œâ”€ xUnit å–®å…ƒæ¸¬è©¦ (85% è¦†è“‹)
â””â”€ Roslyn å®‰å…¨æƒæ

äº¤å‰æª¢æŸ¥
â”œâ”€ æ–‡ä»¶ç·¨ç¢¼æª¢æŸ¥
â”œâ”€ .editorconfig é©—è­‰
â””â”€ çµæœåŒ¯ç¸½å ±å‘Š
```

**æˆåŠŸæ¨™æº–ï¼š** All jobs success

**å¤±æ•—è™•ç†ï¼š** âŒ ä»»ä½•æª¢æŸ¥å¤±æ•— â†’ PR è¢«é˜»æ­¢åˆä½µ

---

### 2. pr-checks.ymlï¼ˆä»£ç¢¼å¯©æŸ¥å”åŠ©ï¼‰

**è§¸ç™¼æ¢ä»¶ï¼š** PR è¢«æ‰“é–‹æˆ–æ›´æ–°

**åŸ·è¡Œå…§å®¹ï¼š**

| æª¢æŸ¥ | è§¸ç™¼å‹•ä½œ |
|------|--------|
| **PR è¦æ¨¡åˆ†æ** | >15 files æˆ– >500 lines â†’ è‡ªå‹•è©•è«–å»ºè­°æ‹†åˆ† |
| **æ¸¬è©¦è¦†è“‹åˆ†æ** | ä»£ç¢¼æ”¹å‹•ä½†ç„¡æ¸¬è©¦æ”¹å‹• â†’ è‡ªå‹•è©•è«–æé†’ |
| **è‡ªå‹•æª¢æŸ¥æ¸…å–®** | è‡ªå‹•è©•è«–åŒ…å«äººå·¥æª¢æŸ¥é …çš„æ¸…å–® |
| **å¤§å‹ PR æ¨™è¨˜** | æ·»åŠ  `large-pr` æ¨™ç±¤ï¼Œä¾¿æ–¼ç¯©é¸ |
| **ä¾è³´å®‰å…¨æª¢æŸ¥** | æª¢æŸ¥ Python/npm/.NET çš„å·²çŸ¥æ¼æ´ |

---

## ğŸ“¥ å®‰è£æ­¥é©Ÿ

### Step 1: å°‡å·¥ä½œæµæ–‡ä»¶æ”¾å…¥é …ç›®

```bash
# åœ¨ä½ çš„é …ç›®æ ¹ç›®éŒ„
mkdir -p .github/workflows

# è¤‡è£½å·¥ä½œæµæ–‡ä»¶
cp CI-CD-Pipelines/*.yml .github/workflows/

# æäº¤åˆ° git
git add .github/workflows/
git commit -m "chore: Add GitHub Actions CI/CD pipelines"
git push
```

### Step 2: é©—è­‰å·¥ä½œæµå•Ÿå‹•

1. é€²å…¥ GitHub Repository
2. é»æ“Š `Actions` æ¨™ç±¤
3. æ‡‰è©²çœ‹åˆ°ä¸‰å€‹å·¥ä½œæµï¼š
   - CI Pipeline - Multi-Stack
   - PR Checks & Code Review
   - Release Pipeline

### Step 3: é…ç½®åˆ†æ”¯ä¿è­·è¦å‰‡

```
Settings â†’ Branches â†’ Branch protection rules â†’ main

ä¿è­·è¦å‰‡ï¼š
âœ… Require status checks to pass before merging
   â”œâ”€ backend-python
   â”œâ”€ frontend-typescript
   â”œâ”€ backend-csharp
   â””â”€ cross-stack-checks

âœ… Require linear history
âœ… Require conversation resolution before merging
âœ… Require code reviews before merging
   â””â”€ Required number of approvals: 1

âœ… Dismiss stale review approvals when new commits are pushed
âœ… Restrict who can push to matching branches (å¯é¸)
```

---

## ğŸ”§ è‡ªå®šç¾©èˆ‡é…ç½®

### ä¿®æ”¹æª¢æŸ¥ç­–ç•¥

**ä¿®æ”¹æ¸¬è©¦è¦†è“‹ç‡è¦æ±‚ï¼š**

ç·¨è¼¯ `main-pipeline.yml`ï¼š

```yaml
# Python
pytest src/backend/python/tests \
  --cov-fail-under=90  # â† æ”¹æˆä½ æƒ³è¦çš„æ•¸å­—ï¼ˆç¯„åœ 50-100ï¼‰

# TypeScript
npm run test:coverage --coverage-reporter=text-summary
# åœ¨ vitest.config.ts ä¸­æ”¹ coverage.lines

# C#
/p:CoverageThreshold=85  # â† æ”¹æˆä½ æƒ³è¦çš„æ•¸å­—
```

**ä¿®æ”¹ Lint åš´æ ¼åº¦ï¼š**

```yaml
# Python: æ”¹ç‚º warning ä¸é˜»æ­¢
ruff check src/backend/python || true

# TypeScript: æ”¹ç‚º warning ä¸é˜»æ­¢
npm run lint || true

# C#: å·²è¨­ç‚º warning ç­‰ç´š
```

### ç¦ç”¨æŸå€‹æª¢æŸ¥

```yaml
# åœ¨ job ä¸­æ·»åŠ  if æ¢ä»¶
python-backend:
  if: false  # â† ç¦ç”¨æ­¤ job
  runs-on: ubuntu-latest
```

---

## ğŸ“Š ç›£æ§èˆ‡æ•…éšœæ’é™¤

### æŸ¥çœ‹ CI ç‹€æ…‹

```
GitHub Repository â†’ Actions â†’ é¸æ“‡å·¥ä½œæµ â†’ æŸ¥çœ‹æœ€æ–°é‹è¡Œ

é¡¯ç¤ºä¿¡æ¯ï¼š
âœ… All checks passed
âŒ Some checks failed
  â””â”€ é»æ“Šå¤±æ•—çš„ job æŸ¥çœ‹è©³ç´°æ—¥èªŒ
```

### å¸¸è¦‹çš„å¤±æ•—å ´æ™¯èˆ‡è§£æ±ºæ–¹æ¡ˆ

#### å ´æ™¯ 1: Black æ ¼å¼æª¢æŸ¥å¤±æ•—

**éŒ¯èª¤ä¿¡æ¯ï¼š**
```
would reformat src/backend/python/app.py
```

**è§£æ±ºï¼š**
```bash
# æœ¬åœ°è‡ªå‹•æ ¼å¼åŒ–
black src/backend/python

# æäº¤ä¿®å¾©
git add .
git commit -m "style: auto-format with Black"
git push
```

#### å ´æ™¯ 2: Ruff Lint æª¢æŸ¥å¤±æ•—

**éŒ¯èª¤ä¿¡æ¯ï¼š**
```
E501: Line too long (145 > 88 characters)
F841: Local variable assigned but never used
```

**è§£æ±ºï¼š**
```bash
# å˜—è©¦è‡ªå‹•ä¿®å¾©
ruff check src/backend/python --fix

# æ‰‹å‹•ä¿®å¾©å¾Œæäº¤
git add .
git commit -m "fix: resolve lint issues"
git push
```

#### å ´æ™¯ 3: é¡å‹æª¢æŸ¥å¤±æ•— (TypeScript)

**éŒ¯èª¤ä¿¡æ¯ï¼š**
```
error TS2531: Object is possibly 'null'
```

**è§£æ±ºï¼š**
```typescript
// æ·»åŠ é¡å‹æª¢æŸ¥
if (obj !== null) {
  console.log(obj.property);  // âœ… Now safe
}

// æˆ–ä½¿ç”¨éç©ºæ–·è¨€ï¼ˆä¸æ¨è–¦ï¼‰
console.log(obj!.property);  // âš ï¸ Opt-out of checking
```

#### å ´æ™¯ 4: æ¸¬è©¦è¦†è“‹ç‡ä¸è¶³

**éŒ¯èª¤ä¿¡æ¯ï¼š**
```
FAILED: Coverage threshold (90%) not met (85%)
```

**è§£æ±ºï¼š**

```bash
# æŸ¥çœ‹è¦†è“‹ç‡å ±å‘Š
coverage report  # Python

# æ·»åŠ ç¼ºå¤±çš„æ¸¬è©¦
# æª¢æŸ¥ htmlcov/index.html æ‰¾å‡ºæœªè¦†è“‹çš„ä»£ç¢¼

# æˆ–è‡¨æ™‚é™ä½è¦æ±‚ï¼ˆä¸æ¨è–¦ï¼‰
# --cov-fail-under=85
```

#### å ´æ™¯ 5: Docker ç›¸é—œæª¢æŸ¥å¤±æ•—

**éŒ¯èª¤ä¿¡æ¯ï¼š**
```
no matching manifest for linux/amd64
```

**è§£æ±ºï¼š**
```bash
# ç¢ºä¿ Dockerfile æ­£ç¢º
docker build -f Dockerfile.python .

# æ¨é€åˆ° registry å‰æ¸¬è©¦
docker run -it <image-id> /bin/bash
```

---

## ğŸ“ˆ æ€§èƒ½å„ªåŒ–

### åŠ å¿« CI åŸ·è¡Œ

**è¨­ç½® Python ä¾è³´ç·©å­˜ï¼š**

```yaml
- uses: actions/setup-python@v5
  with:
    python-version: '3.11'
    cache: 'pip'  # â† è‡ªå‹•ç·©å­˜ pip ä¾è³´
```

**è¨­ç½® Node ä¾è³´ç·©å­˜ï¼š**

```yaml
- uses: actions/setup-node@v4
  with:
    node-version: '20'
    cache: 'npm'  # â† è‡ªå‹•ç·©å­˜ npm ä¾è³´
```

**ä¸¦è¡ŒåŸ·è¡Œ Jobsï¼š**

```yaml
# é»˜èªå°±æ˜¯ä¸¦è¡Œçš„ï¼Œç„¡éœ€é…ç½®
# ä¸‰å€‹å¾Œç«¯ job åŒæ™‚é‹è¡Œï¼Œå…± 5-10 åˆ†é˜
```

### é æœŸé‹è¡Œæ™‚é–“

| Job | é¦–æ¬¡é‹è¡Œ | å¾ŒçºŒé‹è¡Œï¼ˆæœ‰ç·©å­˜ï¼‰ |
|-----|--------|---------------|
| Python | 3-5 åˆ†é˜ | 1-2 åˆ†é˜ |
| TypeScript | 2-4 åˆ†é˜ | 1-2 åˆ†é˜ |
| C# | 2-3 åˆ†é˜ | 1-2 åˆ†é˜ |
| **ä¸¦è¡Œç¸½è€—æ™‚** | **5-10 åˆ†é˜** | **3-5 åˆ†é˜** |

---

## ğŸ” å®‰å…¨æœ€ä½³å¯¦è¸

### ä¿è­·æ•æ„Ÿä¿¡æ¯

âŒ **ä¸è¦åœ¨å·¥ä½œæµä¸­ç¡¬ç·¨ç¢¼å¯†é‘°ï¼š**

```yaml
# âŒ ä¸è¦é€™æ¨£åš
env:
  DATABASE_URL: "postgresql://user:password@host/db"
  API_KEY: "sk_live_xxxxx"
```

âœ… **ä½¿ç”¨ GitHub Secretsï¼š**

```yaml
# âœ… é€™æ¨£åš
env:
  DATABASE_URL: ${{ secrets.DATABASE_URL }}
  API_KEY: ${{ secrets.API_KEY }}
```

**è¨­ç½®æ­¥é©Ÿï¼š**

1. Go to Repository Settings
2. Secrets and variables â†’ Actions
3. New repository secret
4. æ·»åŠ  DATABASE_URL, API_KEY ç­‰

### é™åˆ¶å·¥ä½œæµæ¬Šé™

```yaml
permissions:
  contents: read
  pull-requests: write
  checks: write
  # æ˜ç¢ºé™åˆ¶ï¼Œé¿å…ä¸å¿…è¦çš„æ¬Šé™
```

---

## ğŸ“ ç¶­è­·æ¸…å–®

### æ¯æœˆæª¢æŸ¥

- [ ] æª¢æŸ¥å·¥ä½œæµå¤±æ•—ç‡ (ç›®æ¨™ < 5%)
- [ ] æª¢æŸ¥ä¾è³´æ›´æ–° (npm/pip/nuget)
- [ ] é©—è­‰åˆ†æ”¯ä¿è­·è¦å‰‡ä»é©ç”¨
- [ ] æª¢æŸ¥ CI åŸ·è¡Œæ™‚é–“è¶¨å‹¢

### å­£åº¦æª¢æŸ¥

- [ ] è©•ä¼°æ¸¬è©¦è¦†è“‹ç‡æ˜¯å¦é‚„åˆé©
- [ ] æ±ºå®šæ˜¯å¦å•Ÿç”¨é¡å¤–çš„æª¢æŸ¥ (SonarQube, etc.)
- [ ] æª¢æŸ¥æ˜¯å¦æœ‰æ–°çš„å®‰å…¨æ¼æ´æƒæå·¥å…·
- [ ] æ ¹æ“šåœ˜éšŠåé¥‹èª¿æ•´ Lint è¦å‰‡

---

## ğŸ“ å­¸ç¿’è³‡æº

- [GitHub Actions å®˜æ–¹æ–‡æª”](https://docs.github.com/actions)
- [Ruff æ–‡æª”](https://docs.astral.sh/ruff/)
- [ESLint æ–‡æª”](https://eslint.org/docs)
- [pytest æ–‡æª”](https://docs.pytest.org/)
- [Vitest æ–‡æª”](https://vitest.dev/)

---

## ğŸ’¬ å¸¸è¦‹å•é¡Œ

**Q: CI ç‚ºä»€éº¼é‚£éº¼æ…¢ï¼Ÿ**
A: é¦–æ¬¡é‹è¡Œæœƒä¸‹è¼‰æ‰€æœ‰ä¾è³´ã€‚å¾ŒçºŒé‹è¡Œæœƒä½¿ç”¨ç·©å­˜ã€‚å¦‚æœä¸å¤ å¿«ï¼Œæª¢æŸ¥æ˜¯å¦ï¼š
- æœ‰ä¸å¿…è¦çš„ sleep å‘½ä»¤
- Docker å±¤æ²’æœ‰é©ç•¶ç·©å­˜
- ç¶²çµ¡é€£æ¥å•é¡Œ

**Q: èƒ½å¦è·³é CI æª¢æŸ¥ï¼Ÿ**
A: âœ… å¯ä»¥ï¼Œä½†ä¸æ¨è–¦ï¼š
```bash
git push --no-verify  # è·³éæœ¬åœ° hook
```

**Q: ä½•æ™‚æ‡‰è©²ç¦ç”¨æŸå€‹æª¢æŸ¥ï¼Ÿ**
A: åªåœ¨ä»¥ä¸‹æƒ…æ³ï¼š
- æª¢æŸ¥å·¥å…·æœ¬èº«æœ‰èª¤  
- å°è©²é …ç›®å®Œå…¨ä¸é©ç”¨
- èˆ‡æ›´é«˜å„ªå…ˆç´šçš„è¦æ±‚è¡çª

**Q: å¦‚ä½•åœ¨æœ¬åœ°æ¸¬è©¦ GitHub Actionsï¼Ÿ**
A: ä½¿ç”¨ [act](https://github.com/nektos/act)ï¼š
```bash
# å®‰è£
choco install act  # Windows

# é‹è¡Œæœ¬åœ°æ¸¬è©¦
act -j backend-python
```

---

## ğŸ“ æ”¯æ´

å¦‚é‡å•é¡Œï¼Œè«‹å…ˆæª¢æŸ¥ï¼š
1. GitHub Actions æ—¥èªŒï¼ˆActions tab â†’ é¸æ“‡ workflow â†’ é»æ“Šå¤±æ•—çš„ runï¼‰
2. æœ¬æŒ‡å—çš„æ•…éšœæ’é™¤éƒ¨åˆ†
3. ç›¸æ‡‰å·¥å…·çš„å®˜æ–¹æ–‡æª”

--

**æœ€å¾Œæ›´æ–°ï¼š2026-02-13**
**ç‰ˆæœ¬ï¼šv1.0-mvp**
