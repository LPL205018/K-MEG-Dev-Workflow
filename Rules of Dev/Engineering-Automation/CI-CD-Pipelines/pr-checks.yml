name: PR Checks & Code Review Actions

on:
  pull_request:
    types: [opened, reopened, synchronize, ready_for_review]

permissions:
  pull-requests: write
  checks: write

jobs:
  # ===== è‡ªå‹• PR æª¢æŸ¥ =====
  pr-validation:
    runs-on: ubuntu-latest
    name: "PR Validation"
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å®Œæ•´æ­·å²ï¼Œç”¨æ–¼æ¯”è¼ƒ
      
      # æª¢æŸ¥ 1: PR è¦æ¨¡
      - name: Check PR size
        run: |
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }} HEAD | wc -l)
          CHANGED_LINES=$(git diff -U0 origin/${{ github.base_ref }} HEAD | grep -E "^[+-]" | wc -l)
          
          echo "ğŸ“Š PR Statistics:"
          echo "   Changed files: $CHANGED_FILES"
          echo "   Changed lines: $CHANGED_LINES"
          
          if [ $CHANGED_FILES -gt 15 ]; then
            echo "âš ï¸  å¤§å‹ PR æé†’ï¼šæ”¹å‹•è¶…é 15 å€‹æ–‡ä»¶ï¼Œå»ºè­°æ‹†åˆ†ç‚ºæ›´å°çš„ PR"
          fi
          
          if [ $CHANGED_LINES -gt 500 ]; then
            echo "âš ï¸  Large PR æé†’ï¼šæ”¹å‹•è¶…é 500 è¡Œï¼Œå»ºè­°æ‹†åˆ†ç‚ºæ›´å°çš„ PR"
          fi
      
      # æª¢æŸ¥ 2: æ¸¬è©¦æ–‡ä»¶è®Šå‹•
      - name: Check test coverage impact
        run: |
          TEST_CHANGES=$(git diff origin/${{ github.base_ref }} HEAD | grep -E "^[+-].*test" | wc -l)
          CODE_CHANGES=$(git diff origin/${{ github.base_ref }} HEAD | grep -E "^[+-].*\.(py|ts|tsx|cs)$" | wc -l)
          
          if [ $CODE_CHANGES -gt 0 ] && [ $TEST_CHANGES -eq 0 ]; then
            echo "âš ï¸  æœªç™¼ç¾ç›¸æ‡‰çš„æ¸¬è©¦æ”¹å‹•"
            echo "   ä»£ç¢¼è®Šå‹•: $CODE_CHANGES è¡Œ"
            echo "   æ¸¬è©¦è®Šå‹•: $TEST_CHANGES è¡Œ"
            echo "ğŸ’¡ å»ºè­°: æ·»åŠ å°æ‡‰çš„å–®å…ƒæ¸¬è©¦"
          fi
      
      - name: Post PR comment with checks
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.issue.number;
            
            // æª¢æŸ¥æ¸…å–®è©•è«–
            const checklist = `
## âœ… è‡ªå‹•æª¢æŸ¥æ¸…å–®

æœ¬ PR å·²è‡ªå‹•æª¢æŸ¥ä»¥ä¸‹é …ç›®ï¼Œè«‹åœ¨åˆä½µå‰ç¢ºä¿å…¨éƒ¨é€šéï¼š

### ä»£ç¢¼å“è³ª
- [ ] âœ… ä»£ç¢¼æ ¼å¼æª¢æŸ¥ (Prettier/Black) - è‡ªå‹•åŒ–åŸ·è¡Œ
- [ ] âœ… Lint éœæ…‹åˆ†æ (ESLint/Ruff) - è‡ªå‹•åŒ–åŸ·è¡Œ
- [ ] âœ… é¡å‹æª¢æŸ¥ (TypeScript/Pyright) - è‡ªå‹•åŒ–åŸ·è¡Œ
- [ ] âœ… å–®å…ƒæ¸¬è©¦é€šé (â‰¥90% è¦†è“‹) - è‡ªå‹•åŒ–åŸ·è¡Œ

### äººå·¥å¯©æŸ¥
- [ ] ä»£ç¢¼é‚è¼¯æ¸…æ™°æ˜“æ‡‚
- [ ] å‘½åç¬¦åˆè¦ç¯„
- [ ] è¨»é‡‹è§£é‡‹ã€Œç‚ºä»€éº¼ã€è€Œéã€Œåšä»€éº¼ã€
- [ ] æ²’æœ‰éºç•™çš„ TODO / FIXME
- [ ] æ²’æœ‰ç¡¬ç·¨ç¢¼çš„é­”è¡“å­—ç¬¦ä¸²/æ•¸å­—

### PR æœ¬èº«
- [ ] PR æ¨™é¡Œæ¸…æ™°æ˜ç¢º
- [ ] PR æè¿°è§£é‡‹è®Šå‹•èƒŒæ™¯
- [ ] ç›¸é—œ Issue å·²é—œè¯
- [ ] æ–‡æª”å·²æ›´æ–°ï¼ˆå¦‚é©ç”¨ï¼‰

---

**è‡ªå‹•åŒ–æª¢æŸ¥çµæœ:** å°åŒ—è¦‹è©³ç´°å ±å‘Š â†™ï¸

**æç¤º**: è‡ªå‹•åŒ–æª¢æŸ¥å¤±æ•—æ™‚ï¼ŒPR æœƒè¢«é˜»æ­¢åˆä½µã€‚è«‹é»æ“Šè©³ç´°å ±å‘ŠæŸ¥çœ‹å…·é«”éŒ¯èª¤ã€‚
            `;
            
            github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: checklist
            });

  # ===== è‡ªå‹•æª¢æŸ¥å¤§å‹ PR =====
  large-pr-check:
    runs-on: ubuntu-latest
    name: "Large PR Detection"
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Flag large PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            const prNumber = context.issue.number;
            const files = context.payload.pull_request?.changed_files || 0;
            const additions = context.payload.pull_request?.additions || 0;
            
            if (files > 15 || additions > 500) {
              github.rest.issues.addLabels({
                issue_number: prNumber,
                owner: context.repo.owner,
                repo: context.repo.repo,
                labels: ['large-pr', 'needs-review']
              });
              
              github.rest.issues.createComment({
                issue_number: prNumber,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: 'âš ï¸ **å¤§å‹ PR æé†’**\n\næ­¤ PR æ”¹å‹•è¶…éæ¨™æº–è¦æ¨¡ï¼ˆ>15 æ–‡ä»¶ æˆ– >500 è¡Œï¼‰ã€‚å»ºè­°æ‹†åˆ†ç‚ºå¤šå€‹è¼ƒå°çš„ PR ä»¥ä¾¿å¯©æŸ¥ã€‚'
              });
            }

  # ===== è‡ªå‹•æª¢æ¸¬è¦†è“‹ç‡ä¸‹é™ =====
  coverage-regression-check:
    runs-on: ubuntu-latest
    name: "Coverage Regression Detection"
    if: github.event.pull_request.draft == false
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      # æ³¨æ„ï¼šæ­¤æ­¥é©Ÿä¾è³´ coverage.xml è¢«ä¸Šå‚³ç‚º artifact
      # éœ€è¦é…åˆ main-pipeline.yml ä¸­çš„è¦†è“‹ç‡ä¸Šå‚³
      
      - name: Compare test coverage
        uses: actions/github-script@v7
        with:
          script: |
            // ç°¡åŒ–ç‰ˆæœ¬ï¼šå¯¦éš›ä½¿ç”¨æ™‚å»ºè­°é›†æˆ codecov
            console.log('Coverage comparison logic would run here');
            console.log('If coverage dropped >2%, mark PR for review');

  # ===== Dependency æª¢æŸ¥ =====
  dependency-check:
    runs-on: ubuntu-latest
    name: "Dependency Security Check"
    
    steps:
      - uses: actions/checkout@v4
      
      # Python ä¾è³´
      - name: Check Python dependencies
        run: |
          if [ -f "src/backend/python/requirements.txt" ]; then
            pip install safety
            safety check -r src/backend/python/requirements.txt --json || true
          fi
      
      # npm ä¾è³´
      - name: Check npm dependencies
        run: |
          if [ -f "src/frontend/package.json" ]; then
            cd src/frontend
            npm audit --production --audit-level=moderate || true
          fi
      
      # .NET ä¾è³´
      - name: Check .NET dependencies
        run: |
          if [ -d "src/backend/csharp" ]; then
            cd src/backend/csharp
            dotnet list package --vulnerable
          fi

  # ===== Draft PR æé†’ =====
  draft-pr-notice:
    runs-on: ubuntu-latest
    name: "Draft PR Notice"
    if: github.event.pull_request.draft == true
    
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ğŸ“ **Draft PR æé†’**\n\næ­¤ PR è™•æ–¼è‰ç¨¿ç‹€æ…‹ã€‚æº–å‚™å¥½é€²è¡Œæ­£å¼å¯©æŸ¥æ™‚ï¼Œè«‹é»æ“Šã€ŒReady for reviewã€æŒ‰éˆ•ã€‚'
            });
